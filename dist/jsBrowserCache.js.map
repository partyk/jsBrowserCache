{"version":3,"sources":["../src/jsBrowserCache.js"],"names":["JsBrowserCache","options","_options","prefix","_seconds","testSupportsStorage","key","value","_supportsStorage","undefined","localStorage","e","_setItem","_removeItem","_IsExceptionOutOfSpace","length","expiration","record","actualTimeStamp","Date","getTime","isSupportsStorage","_jsonToString","create","expire","clearExpirate","_getItem","_stringToJson","keys","Object","filter","v","startsWith","i","replace","setItem","getItem","removeItem","json","JSON","stringify","string","parse","name"],"mappings":"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","file":"jsBrowserCache.js","sourcesContent":["\"use strict\";\r\n/**\r\n * @class JsBrowserCache\r\n * trida na praci s localStorage\r\n */\r\nclass JsBrowserCache {\r\n    \r\n    /**\r\n     * @constructor\r\n     * @param {Object} options nastaveni\r\n     */\r\n    constructor(options) {\r\n        console.info('Creat object JsBrowserCache');\r\n\r\n        /**\r\n         * nastaveni tridy\r\n         * @private\r\n         * @type {Object}\r\n         */\r\n        this._options = Object.assign({}, {\r\n            prefix : 'mafra-',\r\n\r\n        }, options || {});\r\n\r\n        /**\r\n         * pomocna promena pro prepocet z milisekund na sekundy\r\n         * @private\r\n         * @type {Number}\r\n         */\r\n        this._seconds = 1*1000;\r\n\r\n        //otestuji podporu storage\r\n        this.testSupportsStorage()\r\n    }\r\n\r\n    /**\r\n     * metoda testuje prohlizec na podporu localStorage\r\n     * @public\r\n     * @returns {Boolean}\r\n     */\r\n    testSupportsStorage() {\r\n        //vytvorim unikatni klic\r\n        let key = 'j8EiBTWwQV',\r\n            value = key;\r\n\r\n        //pokud jsem jiz testoval, tak nemusim znova\r\n        if (this._supportsStorage !== undefined) {\r\n            return this._supportsStorage;\r\n        }\r\n        \r\n        //otestuji localStorage\r\n        try {\r\n            //nekterym prohlizecum staci jen podminka\r\n            if (!localStorage) {\r\n                return false;\r\n            }\r\n        } catch (e) {\r\n            //osatni prohlizece vyhazuji exception\r\n            return false;\r\n        }         \r\n    \r\n        try {\r\n            //spravnou funkcnost otestuji zapisem a ctenim z storage\r\n            this._setItem(key, value);\r\n            this._removeItem(key);\r\n            this._supportsStorage = true; //pokud projde zapis a cteni nastavim podporu na true\r\n        } catch (e) {\r\n            console.warn(e);\r\n            //otestuji jestli neni storage plna\r\n            if (this._IsExceptionOutOfSpace(e) && localStorage.length) {\r\n                this._supportsStorage  = true;\r\n            } else {\r\n                this._supportsStorage  = false;\r\n            }\r\n        }\r\n        return this._supportsStorage;\r\n    }\r\n\r\n    /**\r\n     * vrati tru pokud prohlizec podporuje storage\r\n     * @public\r\n     * @returns {Boolean}\r\n     */\r\n    isSupportsStorage() {\r\n        if (!this._supportsStorage) {\r\n            console.warn('Browser does not support storage');\r\n        }\r\n        return this._supportsStorage;\r\n    }\r\n    \r\n    /**\r\n     * zapise hodnotu do storage\r\n     * \r\n     * @public\r\n     * \r\n     * @param {String} key klic\r\n     * @param {String|Array|Object|Number} value hodnota muze byt String, Array, Json\r\n     * @param {Number} expiration je nepovinny parametr a udava se v sekundach. \r\n     * \r\n     * @example\r\n     *  var cache = new JsBrowserCache();\r\n     *      cache.setItem('test', 'test string');  \r\n     *      cache.setItem('test1', 'test string', 60); //expire 60seconds   \r\n     * \r\n     * @returns {Bool} vrati hodntu true pokud se hodnota zapise do storage\r\n     */\r\n    setItem(key, value, expiration) {\r\n        let record,\r\n            actualTimeStamp = new Date().getTime();\r\n        \r\n        //otestuji jestli je podporovana storage\r\n        if(!this.isSupportsStorage()) {\r\n            return false;\r\n        }\r\n\r\n        console.info('Actual time stamp: ' + actualTimeStamp);\r\n        console.info('Expire: ' + (expiration ? actualTimeStamp + expiration*1*this._seconds : ''));\r\n\r\n        record = {\r\n            value: this._jsonToString(value),\r\n            create: actualTimeStamp,\r\n            expire: expiration ? actualTimeStamp + expiration*1*this._seconds : ''\r\n        }\r\n\r\n        console.info(record);\r\n\r\n        try {\r\n            this._removeItem(key);\r\n            this._setItem(key, this._jsonToString(record));\r\n            return true;\r\n        } catch (e) {\r\n            console.warn(e);\r\n            //zachytavam vyjimku pro pripad ze jeplna storage\r\n            if (this._IsExceptionOutOfSpace(e) && localStorage.length) {\r\n                this.clearExpirate();\r\n                this._setItem(key, this._jsonToString(record));\r\n                //a otestuji jestli se zapsala a vratim Bool\r\n                return !!this._getItem(key);\r\n            } else {\r\n                return false;\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * vrati hodnotu ze storage na zaklade zadaneho klice.\r\n     * @public\r\n     * @param {String} key klic zaznamu\r\n     *  \r\n     * @example\r\n     *  var cache = new JsBrowserCache();\r\n     *      cache.getItem('test');\r\n     * \r\n     * @returns {String|Array|Object|Number|Null} pokud klic neexistuje vratí null jinak vrati zapsanou hodnotu ve storage\r\n     */\r\n    getItem(key) {\r\n        let record;\r\n    \r\n        //otestuji jestli je podporovana storage\r\n        if(!this.isSupportsStorage()) {\r\n            return null;\r\n        }\r\n\r\n        //ziskam zaznma ze storage\r\n        record = this._getItem(key);\r\n\r\n        console.info(record);\r\n\r\n        //zjistim jestli polozka existuje\r\n        if(!record) {\r\n            return null;\r\n        }\r\n\r\n        //prevedu string na json\r\n        record = this._stringToJson(record);\r\n\r\n        console.info(record);\r\n\r\n        //otestuji jestli je polozka expirovana\r\n        if(record.expire && new Date().getTime() > record.expire) {\r\n            console.log('Item \"' + key + '\" is expired. Item is removed.');\r\n            this._removeItem(key);\r\n            return null;\r\n        } else {\r\n            return this._stringToJson(record.value);\r\n        }       \r\n    }\r\n\r\n    /**\r\n     * vymaze expirovane zaznamy ze storage\r\n     * @public\r\n     * \r\n     * @example\r\n     *  var cache = new JsBrowserCache();\r\n     *      cache.clearExpirate();\r\n     * \r\n     */\r\n    clearExpirate() {\r\n        let keys;\r\n        \r\n        //otestuji jestli je podporovana storage\r\n        if(!this.isSupportsStorage()) {\r\n            return null;\r\n        }\r\n\r\n        //pokud je neco v storage, tak pokracuji\r\n        if (localStorage.length > 0) {\r\n\r\n            //ziskam vsechny klice ktere odpovidaji prefixu\r\n            keys = Object.keys(localStorage).filter( v => v.startsWith(this._options.prefix) );\r\n\r\n            if (keys.length > 0) {\r\n                for (let i = 0, length = keys.length; i < length; i++){\r\n                    let key = keys[i].replace(this._options.prefix,''), //odeberu u klice prefix\r\n                        record = this._stringToJson(this._getItem(key)); \r\n\r\n                    //otestuji jestli je polozka expirovana\r\n                    if(record.expire && new Date().getTime() > record.expire) {\r\n                        console.info('Item \"' + key + '\" is expired. Item is removed.'); \r\n                        this._removeItem(key);\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * ulozi zaznam do storage\r\n     * @private\r\n     * @param {String} key klic\r\n     * @param {String} value hodnota\r\n     */\r\n    _setItem(key, value) {\r\n        localStorage.setItem(this._options.prefix + key, value);\r\n    }\r\n\r\n    /**\r\n     * vrati zaznam z storage\r\n     * @private\r\n     * @param {String} key \r\n     * @returns {String}\r\n     */\r\n    _getItem(key) {\r\n        return localStorage.getItem(this._options.prefix + key);\r\n    }\r\n\r\n    /**\r\n     * smaze hodntu z storage\r\n     * @private\r\n     * @param {String} key \r\n     */\r\n    _removeItem(key) {\r\n        localStorage.removeItem(this._options.prefix + key);\r\n    }\r\n\r\n    /**\r\n     * prevede json na string\r\n     * @private\r\n     * @param {Object} json\r\n     * @returns {String}\r\n     */\r\n    _jsonToString(json) {\r\n        return JSON.stringify(json);\r\n    }\r\n\r\n    /**\r\n     * prevede string na json\r\n     * @private\r\n     * @param {String} string \r\n     * @returns {Object}\r\n     */\r\n    _stringToJson(string) {\r\n        return JSON.parse(string);\r\n    }\r\n\r\n    /**\r\n     * otestuje jestli je vyvolaná vyjímka na plný local storge\r\n     * @param {Object} e exception\r\n     * @returns {Bool}\r\n     */\r\n    _IsExceptionOutOfSpace(e) {\r\n        return (e && e.name === 'QUOTA_EXCEEDED_ERR' ||\r\n            e.name === 'NS_ERROR_DOM_QUOTA_REACHED' ||\r\n            e.name === 'QuotaExceededError');\r\n    }\r\n}"]}